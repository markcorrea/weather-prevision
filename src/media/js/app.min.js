(function () {
    'use strict';

    angular
        .module('app', [
            'ui.router',
            'ngResource',
            'app.modules',
            'app.modules.cities',
            'app.services.cities',
            'app.services.weather',
            'app.filters',
            'ui.bootstrap',
            'chart.js'
        ]);

    //angular.module('app.services', []);
    angular.module('app.filters', []);
}());
(function() {
    'use strict';

    angular
        .module('app')
        .config(['$stateProvider', '$urlRouterProvider', function ($stateProvider, $urlRouterProvider) {

            $urlRouterProvider.otherwise("/");

            $stateProvider
                .state('home', {
                    url: '/',
                    onEnter: ['$state', '$timeout', function ($state, $timeout) {
                        $state.go('modules.cities');
                    }]
                });
        }]);
}());
/**
 * Created by marcus on 6/22/17.
 */
(function () {
    'use strict';

    angular
        .module('app.filters')
        .filter('filterTemp', ['$filter', filterTemp]);

    //
    // Recebe o formato da temperatura, dando a ele apenas um decimal, quando necessário;
    //
    function filterTemp($filter) {
        return function (temp) {
            return parseFloat(temp).toFixed(1);
        };
    }

})();

(function () {
    'use strict';

    angular
        .module('app.modules', ['ui.router', 'app.modules.cities.controllers'])
        .config(['$stateProvider', function ($stateProvider) {
            $stateProvider
                .state('modules', {
                    idRoute: 'modules',
                    parent: '',
                    url: "",
                    views: {
                        'app.body': {
                            templateUrl: 'app/modules/modules-body.html'
                        }
                    },
                    abstract: true
                });
        }]);
}());
(function () {
   'use strict';

    function getAPIURL() {
        return 'mocks/';
    }

    function defaultOptionsResource() {
        return {
            'update': {method: 'PUT'}
        }
    }

    function CitiesService($resource, $q) {

        var $public = {};
        var $private = {};

        $private.setUrlAPIDefault = function (afterURL) {
            afterURL = afterURL || '';
            $private.API = $resource(getAPIURL() + afterURL, {}, defaultOptionsResource());
        };

        $public.getStates = function () {
            var deferred = $q.defer();

            $private.setUrlAPIDefault('states.json');

            $private.API.get().$promise.then(function (result) {
                if (result.status === 'success') {
                    deferred.resolve(result);
                } else {
                    deferred.reject(result);
                }
            }, function (result) {
                deferred.reject(result);
            });
            return deferred.promise;
        };

        $public.getCitiesByStateId = function (options) {
            var deferred = $q.defer();

            $private.setUrlAPIDefault('states/' + options.id + '.json');

            $private.API.get().$promise.then(function (result) {
               if (result.status === 'success') {
                   deferred.resolve(result);
               } else {
                   deferred.reject(result);
               }
            }, function (result) {
                deferred.reject(result);
            });
            return deferred.promise;
        };

        $public.getSelectedCities = function (options) {
            var deferred = $q.defer();

            $private.setUrlAPIDefault('selected-cities.json');

            $private.API.get().$promise.then(function (result) {
                if (result.status === 'success') {
                    deferred.resolve(result);
                } else {
                    deferred.reject(result);
                }
            }, function (result) {
                deferred.reject(result);
            });
            return deferred.promise;
        };

        $public.getCityById = function (options) {
            var deferred = $q.defer();

            $private.setUrlAPIDefault('cities/' + options.id + '.json');

            $private.API.get().$promise.then(function (result) {
                if (result.status === 'success') {
                    deferred.resolve(result);
                } else {
                    deferred.reject(result);
                }
            }, function (result) {
                deferred.reject(result);
            });
            return deferred.promise;
        };

        return $public;
    }

    angular.module('app.services.cities', []).factory('CitiesService', CitiesService);
}());
(function () {
   'use strict';

    function getAPIURL(city) {
        return 'http://api.openweathermap.org/data/2.5/forecast/daily?q='+city+',br&units=metric&cnt=7&APPID=1dbf8be518c9378dab4765d100499d6c';
    }

    function defaultOptionsResource() {
        return {
            'update': {method: 'PUT'}
        }
    }

    function WeatherService($resource, $q) {

        var $public = {};
        var $private = {};

        $private.setUrlAPIDefault = function (city) {
            $private.API = $resource(getAPIURL(city), {}, defaultOptionsResource());
        };

        $public.getWeatherByCityName = function (options) {
            var deferred = $q.defer();

            $private.setUrlAPIDefault(options.city);

            $private.API.get().$promise.then(function (result) {
                if (result.cod === '200') {
                    deferred.resolve(result);
                } else {
                    deferred.reject(result);
                }
            }, function (result) {
                deferred.reject(result);
            });
            return deferred.promise;
        };

        return $public;
    }

    angular.module('app.services.weather', []).factory('WeatherService', WeatherService);
}());
(function () {
    'use strict';

    angular
        .module('app.modules.cities', ['ui.router', 'app.modules.cities.controllers', 'app.services.weather', 'app.services.cities'])
        .config(['$stateProvider', function ($stateProvider) {
            $stateProvider
                .state('modules.cities', {
                    url: '',
                    views: {
                        'app.modules.content': {
                            templateUrl: 'app/modules/cities/views/view.html',
                            controller: 'citiesViewCtrl'
                        }
                    }
                });
        }]);
}());
(function () {
    'use strict';

    function citiesViewCtrl($scope, $stateParams, CitiesService, WeatherService) {
        $scope.dailyForecast = [];

        CitiesService.getCityById({"id": "1"}).then(function (result) {
            $scope.city = result.data;
        });

        $scope.getForecast = function () {
            WeatherService.getWeatherByCityName({"city": "blumenau"}).then(function (result) {
                $scope.dailyForecast = getNextSixDays(result.list);
                $scope.maxmin = getMaximumAndMinimumTemperature($scope.dailyForecast);
                $scope.beachRecommendation = getNextWeekendBeachPrevision($scope.dailyForecast);
                initChart($scope.dailyForecast);
                console.log($scope.dailyForecast);
            });
        };

        $scope.getForecast();

        var initChart = function (list) {
            $scope.labels = [];
            $scope.series = ['Temperatura'];
            $scope.data = [];

            for (var i = 0; i < list.length; i++) {
                $scope.labels.push($scope.getDayOfTheWeek(list[i].dt).short);
                $scope.data.push(list[i].temp.day);
            }

            $scope.onClick = function (points, evt) {
                console.log(points, evt);
            };
            $scope.datasetOverride = [{yAxisID: 'y-axis-1'}];
            $scope.options = {
                scales: {
                    yAxes: [
                        {
                            id: 'y-axis-1',
                            type: 'linear',
                            display: true,
                            position: 'left'
                        }
                    ]
                }
            };
        };


        //
        //Formata a lista das previsões dos próximos dias para exibir apenas seis;
        //
        var getNextSixDays = function (list) {
            var resultList = [];
            for (var i = 0; i < 6; i++) {
                resultList.push(list[i]);
            }
            return resultList;
        };

        //
        //Verifica temperatura máxima e mínima para o período exibido;
        //
        var getMaximumAndMinimumTemperature = function (list) {
            var temp = {max: 0, min: 0, daymax: "", daymin: ""};
            if (list.length > 0) {
                for (var i = 0; i < list.length; i++) {
                    //console.log(1, list[i]);
                    if (i == 0) {
                        temp.max = list[i].temp.max;
                        temp.min = list[i].temp.min;
                        temp.daymax = list[i].dt;
                        temp.daymin = list[i].dt;
                    }

                    if (list[i].temp.max > temp.max) {
                        temp.max = list[i].temp.max;
                        temp.daymax = list[i].dt;
                    }

                    if (list[i].temp.min < temp.min) {
                        temp.min = list[i].temp.min;
                        temp.daymin = list[i].dt;
                    }
                }
            }
            return temp;
        };

        //
        // Recebe a data em formato timestamp e verifica o dia da semana correspondente;
        // Ao chamar a função, à frente do retorno deve ser informado formato .short (curto) ou .long(longo);
        // Exemplo: etc = $scope.getDayOfTheWeek(12345678).short;
        //
        $scope.getDayOfTheWeek = function (timestamp) {
            var weekDays = [
                {short: "Dom", long: "domingo"},
                {short: "Seg", long: "segunda-feira"},
                {short: "Ter", long: "terça-feira"},
                {short: "Qua", long: "quarta-feira"},
                {short: "Qui", long: "quinta-feira"},
                {short: "Sex", long: "sexta-feira"},
                {short: "Sab", long: "sábado"}
            ];
            var d = new Date(timestamp * 1000);
            return weekDays[d.getDay()];
        };


        var getNextWeekendBeachPrevision = function (list) {
            var prevision = {};
            for (var i = 0; i < list.length; i++) {
                var d = new Date((list[i].dt) * 1000);
                if (d.getDay() == 6) {
                    prevision = list[i];
                    prevision.isGood = (prevision.temp.day > 25 && prevision.weather[0].id == 800);
                }
            }

            return prevision;
        };

        $scope.setWeatherIcon = function (code) {
            return "http://openweathermap.org/img/w/" + code + ".png";
        };
    }

    angular.module('app.modules.cities.controllers', [])
        .controller("citiesViewCtrl", citiesViewCtrl);
}());